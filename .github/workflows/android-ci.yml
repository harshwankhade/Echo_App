name: Android CI

# Trigger on push and pull requests
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout project
        uses: actions/checkout@v4

      # Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Cache Gradle dependencies to speed up builds
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle

      # Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Run code formatting checks
      - name: Run formatting checks (Spotless)
        run: ./gradlew spotlessCheck

      # Run Android Lint analysis
      - name: Run Android Lint
        run: ./gradlew lint

      # Build debug APK
      - name: Build Debug APK
        run: ./gradlew assembleDebug

      # Upload lint report as artifact
      - name: Upload Lint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: app/build/reports/lint-results*.html

      # Run unit tests
      - name: Run unit tests
        run: ./gradlew test

      # Upload test results
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: app/build/test-results/

      # Comment on PR with build status
      - name: Comment PR with build status
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '✅' : '❌';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} Build ${status}: Android CI checks completed. See artifacts for details.`
            });

